From 279e127a9241c70a1075d995bf52d5147de37f68 Mon Sep 17 00:00:00 2001
From: "xiang.zhang" <xiang.zhang@verisilicon.com>
Date: Mon, 16 Aug 2021 13:09:31 +0800
Subject: [PATCH 1/1] Add custom NBG op support in tflite

Signed-off-by: xiang.zhang <xiang.zhang@verisilicon.com>
---
 tensorflow/lite/c/builtin_op_data.h           |  7 ++
 tensorflow/lite/kernels/BUILD                 |  1 +
 tensorflow/lite/kernels/register.cc           |  4 +-
 tensorflow/lite/kernels/register_ref.cc       |  3 +
 .../lite/kernels/vsi_npu_precompiled.cc       | 73 +++++++++++++++++++
 5 files changed, 87 insertions(+), 1 deletion(-)
 create mode 100644 tensorflow/lite/kernels/vsi_npu_precompiled.cc

diff --git a/tensorflow/lite/c/builtin_op_data.h b/tensorflow/lite/c/builtin_op_data.h
index ed5ac004cbd..8f57e255812 100644
--- a/tensorflow/lite/c/builtin_op_data.h
+++ b/tensorflow/lite/c/builtin_op_data.h
@@ -482,6 +482,13 @@ typedef struct {
   int body_subgraph_index;
 } TfLiteWhileParams;
 
+typedef struct {
+  size_t length;
+  size_t input_count;
+  size_t output_cout;
+  char* binary;
+} TfLiteVsiNpuParams;
+
 typedef struct {
   bool exclusive;
   bool reverse;
diff --git a/tensorflow/lite/kernels/BUILD b/tensorflow/lite/kernels/BUILD
index aa2f1456c19..1aecd5984bc 100644
--- a/tensorflow/lite/kernels/BUILD
+++ b/tensorflow/lite/kernels/BUILD
@@ -571,6 +571,7 @@ BUILTIN_KERNEL_SRCS = [
     "depthwise_conv.cc",
     "dequantize.cc",
     "detection_postprocess.cc",
+    "vsi_npu_precompiled.cc",
     "div.cc",
     "elementwise.cc",
     "embedding_lookup.cc",
diff --git a/tensorflow/lite/kernels/register.cc b/tensorflow/lite/kernels/register.cc
index 3e0520f6903..810bf3aa393 100644
--- a/tensorflow/lite/kernels/register.cc
+++ b/tensorflow/lite/kernels/register.cc
@@ -28,7 +28,7 @@ TfLiteRegistration* Register_NUMERIC_VERIFY();
 TfLiteRegistration* Register_AUDIO_SPECTROGRAM();
 TfLiteRegistration* Register_MFCC();
 TfLiteRegistration* Register_DETECTION_POSTPROCESS();
-
+TfLiteRegistration* Register_VSI_NPU_PRECOMPILED();
 }  // namespace custom
 
 namespace builtin {
@@ -333,6 +333,8 @@ BuiltinOpResolver::BuiltinOpResolver() {
             tflite::ops::custom::Register_AUDIO_SPECTROGRAM());
   AddCustom("TFLite_Detection_PostProcess",
             tflite::ops::custom::Register_DETECTION_POSTPROCESS());
+  AddCustom("vsi-npu",
+            tflite::ops::custom::Register_VSI_NPU_PRECOMPILED());
   // By definition, all of the ops added above are not user-defined ops,
   // since they are supported by BuiltinOpResolver.
   may_directly_contain_user_defined_ops_ = false;
diff --git a/tensorflow/lite/kernels/register_ref.cc b/tensorflow/lite/kernels/register_ref.cc
index 2a91442d352..f8924929977 100644
--- a/tensorflow/lite/kernels/register_ref.cc
+++ b/tensorflow/lite/kernels/register_ref.cc
@@ -29,6 +29,7 @@ TfLiteRegistration* Register_NUMERIC_VERIFY_REF();
 TfLiteRegistration* Register_AUDIO_SPECTROGRAM();
 TfLiteRegistration* Register_MFCC();
 TfLiteRegistration* Register_DETECTION_POSTPROCESS();
+TfLiteRegistration* Register_VSI_NPU_PRECOMPILED();
 
 }  // namespace custom
 
@@ -483,6 +484,8 @@ BuiltinRefOpResolver::BuiltinRefOpResolver() {
             tflite::ops::custom::Register_AUDIO_SPECTROGRAM());
   AddCustom("TFLite_Detection_PostProcess",
             tflite::ops::custom::Register_DETECTION_POSTPROCESS());
+  AddCustom("vsi_npu",
+            tflite::ops::custom::Register_VSI_NPU_PRECOMPILED());
 }
 
 }  // namespace builtin
diff --git a/tensorflow/lite/kernels/vsi_npu_precompiled.cc b/tensorflow/lite/kernels/vsi_npu_precompiled.cc
new file mode 100644
index 00000000000..e62fb4d93f8
--- /dev/null
+++ b/tensorflow/lite/kernels/vsi_npu_precompiled.cc
@@ -0,0 +1,73 @@
+/* Copyright 2018 The TensorFlow Authors. All Rights Reserved.
+
+Licensed under the Apache License, Version 2.0 (the "License");
+you may not use this file except in compliance with the License.
+You may obtain a copy of the License at
+
+    http://www.apache.org/licenses/LICENSE-2.0
+
+Unless required by applicable law or agreed to in writing, software
+distributed under the License is distributed on an "AS IS" BASIS,
+WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+See the License for the specific language governing permissions and
+limitations under the License.
+==============================================================================*/
+
+#include <math.h>
+#include <stddef.h>
+#include <stdint.h>
+
+#include <vector>
+
+#include "flatbuffers/flexbuffers.h"  // from @flatbuffers
+#include "tensorflow/lite/c/common.h"
+#include "tensorflow/lite/kernels/internal/optimized/optimized_ops.h"
+#include "tensorflow/lite/kernels/internal/reference/reference_ops.h"
+#include "tensorflow/lite/kernels/internal/spectrogram.h"
+#include "tensorflow/lite/kernels/internal/tensor.h"
+#include "tensorflow/lite/kernels/internal/tensor_ctypes.h"
+#include "tensorflow/lite/kernels/kernel_util.h"
+
+namespace tflite {
+namespace ops {
+namespace custom {
+namespace vsi_npu {
+
+void* Init(TfLiteContext* context, const char* buffer, size_t length) {
+  TfLiteVsiNpuParams* data = reinterpret_cast<TfLiteVsiNpuParams*>(
+      malloc(sizeof(TfLiteVsiNpuParams) + sizeof(char) * length));
+  data->length = length;
+  data->binary = reinterpret_cast<char*>(data) + sizeof(TfLiteVsiNpuParams);
+  memcpy(reinterpret_cast<char*>(data->binary), buffer, length);
+  return reinterpret_cast<void*>(data);
+}
+
+void Free(TfLiteContext* context, void* buffer) {
+  auto* data = reinterpret_cast<TfLiteVsiNpuParams*>(buffer);
+  delete data;
+}
+
+TfLiteStatus Prepare(TfLiteContext* context, TfLiteNode* node) {
+  auto* data =
+      reinterpret_cast<TfLiteVsiNpuParams*>(node->user_data);
+  data->input_count = NumInputs(node);
+  data->output_cout = NumOutputs(node);
+  return kTfLiteOk;
+}
+
+TfLiteStatus Eval(TfLiteContext* context, TfLiteNode* node) {
+  return kTfLiteOk;
+}
+
+}  // namespace vsi_npu
+
+TfLiteRegistration* Register_VSI_NPU_PRECOMPILED() {
+  static TfLiteRegistration r = {
+      vsi_npu::Init, vsi_npu::Free,
+      vsi_npu::Prepare,vsi_npu::Eval};
+  return &r;
+}
+
+}  // namespace custom
+}  // namespace ops
+}  // namespace tflite
-- 
2.25.1

